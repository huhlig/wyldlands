services:
  # PostgreSQL Database
  database:
    build:
      dockerfile: database/Dockerfile
      tags:
        - wyldlands/database:latest
        - wyldlands/database:pv18-age170-vec081
    container_name: wyldlands-database
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5433:5432"
    volumes:
      - database_data:/var/lib/postgresql
      - ./migrations/001_table_setup.sql:/docker-entrypoint-initdb.d/001_table_setup.sql
      - ./migrations/002_settings_data.sql:/docker-entrypoint-initdb.d/002_settings_data.sql
      - ./migrations/003_world_data.sql:/docker-entrypoint-initdb.d/003_world_data.sql
      - ./migrations/004_help_data.sql:/docker-entrypoint-initdb.d/004_help_data.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - wyldlands

  # World Server
  server:
    build:
      context: .
      dockerfile: server/Dockerfile
      tags:
        - wyldlands/server:latest
        - wyldlands/server:local
    container_name: wyldlands-server
    environment:
      WYLDLANDS_DATABASE_URL: postgres://postgres:postgres@wyldlands-database:5432/postgres
      WYLDLANDS_LISTENER_ADDR: 0.0.0.0:6006
      WYLDLANDS_AUTH_KEY: wyldlands-docker-auth-key
      RUST_LOG: debug
    depends_on:
      database:
        condition: service_healthy
    networks:
      - wyldlands
    restart: unless-stopped

  # Gateway Server
  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
      tags:
        - wyldlands/gateway:latest
        - wyldlands/gateway:local
    container_name: wyldlands-gateway
    environment:
      WYLDLANDS_DATABASE_URL: postgres://postgres:postgres@wyldlands-database:5432/postgres
      WYLDLANDS_TELNET_ADDR: 0.0.0.0:4000
      WYLDLANDS_WEBSOCKET_ADDR: 0.0.0.0:8080
      WYLDLANDS_SERVER_ADDR: wyldlands-server:6006
      WYLDLANDS_AUTH_KEY: wyldlands-docker-auth-key
      RUST_LOG: debug
    ports:
      - "4000:4000"  # Telnet
      - "8080:8080"  # WebSocket/HTTP
    depends_on:
      database:
        condition: service_healthy
      server:
        condition: service_started
    networks:
      - wyldlands
    restart: unless-stopped

volumes:
  database_data:
    driver: local

networks:
  wyldlands:
    driver: bridge


